"0",""
"0","# Table10s1, Table10s2, Table10s3, Table10s4, Table10s5, Table10s6"
"0","# Assume GWP is always AR5"
"0",""
"0",""
"0","## for the summary sheets we only need the file for the latest year"
"0",""
"0","files_to_extract <- new_crt_files %>%"
"0","  arrange(iso,year_file) %>% "
"0","  group_by(iso,dir) %>% "
"0","  mutate(include=ifelse(year_file==last(year_file),1,0)) %>% "
"0","  filter(include==1)"
"0",""
"0",""
"0","## prepare data frames"
"0",""
"0","data_crts <- data.frame()"
"0","data_crts_memos <- data.frame()"
"0",""
"0",""
"0","#i=54"
"0",""
"0","for (i in 1:length(files_to_extract$country)) {"
"0","  "
"0","  table_1 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s1""),"
"0","                       startRow = 8) %>% "
"0","    select(""GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktCO2e"") %>% "
"0","    mutate(gas = ""ghg"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  table_2 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s2""),"
"0","                       startRow = 8) %>%"
"0","    select(""GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktCO2"") %>% "
"0","    mutate(gas = ""co2"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  table_3 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s3""),"
"0","                       startRow = 8) %>%"
"0","    select(""GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktCH4e"") %>% "
"0","    mutate(gas = ""ch4"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  table_4 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s4""),"
"0","                       startRow = 8) %>%"
"0","    select(""GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktN2O"") %>% "
"0","    mutate(gas = ""n2o"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  table_5 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s5""),"
"0","                       startRow = 8) %>%"
"0","    select(""GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktCO2e"") %>% "
"0","    mutate(gas = ""fgases"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  table_6 <- read.xlsx(xlsxFile = paste0(""sources/new/"",files_to_extract$dir[i],""/"",files_to_extract$files[i]),"
"0","                       sheet = paste0(""Table10s6""),"
"0","                       startRow = 8) %>%"
"0","    select(""GREENHOUSE.GAS.EMISSIONS.AND.REMOVALS"",matches(""^\\d{4}"")) %>% "
"0","    rename_with(~ substr(., 1, 4), matches(""^\\d{4}"")) %>% "
"0","    mutate(units = ""ktCO2e"") %>% "
"0","    mutate(gas = ""totals"") %>% "
"0","    mutate(across(matches(""^\\d{4}$""), as.character))"
"0","  "
"0","  "
"0","  ## fix up f-gas table"
"0","  table_5 <- table_5 %>% "
"0","    mutate(gas=GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES) %>% "
"0","    mutate(GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES=""2.F. Product uses as substitutes for ODS"")"
"0","  "
"0","  table_5 <- table_5 %>% "
"0","    filter(gas %in% c(""Emissions of HFCs -  CO2 equivalents (kt) (3)"","
"0","                      ""Emissions of PFCs -  CO2 equivalents (kt) "","
"0","                      ""Emissions of  SF6 -  CO2 equivalents (kt) (3)"","
"0","                      ""Emissions of NF3 - CO2 equivalents (kt) (3)"","
"0","                      ""Unspecified mix of  HFCs and PFCs - CO2 equivalents (kt) (3)"")) %>% "
"0","    mutate(gas=ifelse(grepl(""Unspecified"",gas),""hfcs/pfcs (unspecified)"",gas)) %>% "
"0","    mutate(gas=ifelse(grepl(""HFCs"",gas),""hfcs"",gas)) %>% "
"0","    mutate(gas=ifelse(grepl(""PFCs"",gas),""pfcs"",gas)) %>% "
"0","    mutate(gas=ifelse(grepl(""SF6"",gas),""sf6"",gas)) %>% "
"0","    mutate(gas=ifelse(grepl(""NF3"",gas),""nf3"",gas))"
"0","  "
"0","  "
"0","  ## merge co2, ch4, n2o, fgases"
"0","  table <- bind_rows(table_2,table_3,table_4,table_5)"
"0","  table <- table %>% "
"0","    select(sector=GREENHOUSE.GAS.SOURCE.AND.SINK.CATEGORIES,gas,units,everything()) %>% "
"0","    filter(!is.na(sector)) %>% "
"0","    filter(!grepl(""Note:"",sector))"
"0","  table <- gather(table,year,value,-sector,-gas,-units)"
"0","  "
"0","  "
"0","  ## remove some funny character strings that crop up (Maldives)"
"0","  table$sector <- gsub('xml:space=""preserve"">',"""",table$sector)"
"0","  "
"0","  "
"0","  ## deal with NA, NO, IE, NE"
"0","  table <- table %>% "
"0","    mutate(value=ifelse(grepl(""NA"",value),NA,value)) %>% #"
"0","    mutate(value=ifelse(grepl(""IE"",value),NA,value)) %>% # Indicated elsewhere"
"0","    mutate(value=ifelse(grepl(""NE"",value),NA,value)) %>% # Not estimated"
"0","    mutate(value=ifelse(grepl(""NO"",value),0,value)) # Not occurring"
"0","  "
"0","  "
"0","  ## extract sector codes"
"0","  table <- table %>% "
"0","    mutate(sector_code=sub(""^(\\S+)\\s.*"", ""\\1"", sector)) %>% "
"0","    mutate(sector=sub(""^\\S+\\s(.*)"", ""\\1"", sector))"
"0","  "
"0","  "
"0","  ## remove spaces at the beginning of categories"
"0","  table$sector <- gsub(""^\\s+"", """", table$sector)"
"0","  "
"0","  "
"0","  ## extract the emissions hierarchy (just the level associated with each sector)"
"0","  table <- table %>%"
"0","    mutate(sector_level = map_int(sector_code, ~ sum(str_split(.x, ""\\."")[[1]] != """")))"
"0","  "
"0","  "
"0","  ## remove memo items etc."
"0","  memos <- table %>% "
"0","    filter(grepl(""1.D."",sector_code) | grepl(""5.F.1."",sector_code))"
"0","  table <- table %>% "
"0","    filter(!sector_code %in% c(""Memo"",""Indirect"",""Total"")) %>% "
"0","    filter(!grepl(""1.D."",sector_code)) %>% "
"0","    filter(!grepl(""5.F.1."",sector_code))"
"0","  "
"0","  "
"0","  ## clean up"
"0","  table <- table %>% "
"0","    mutate(country=files_to_extract$country[i]) %>% "
"0","    mutate(iso=files_to_extract$iso[i]) %>% "
"0","    mutate(dir=files_to_extract$dir[i]) %>% "
"0","    mutate(year_submission=files_to_extract$year_submission[i]) %>% "
"0","    select(iso,country,dir,year_submission,sector_code,sector_description=sector,sector_level,gas,units,year,value) %>%"
"0","    mutate(value=as.numeric(value)) %>% "
"0","    mutate(year=as.numeric(year))"
"0","  "
"0","  memos <- memos %>% "
"0","    mutate(country=files_to_extract$country[i]) %>% "
"0","    mutate(iso=files_to_extract$iso[i]) %>% "
"0","    mutate(dir=files_to_extract$dir[i]) %>% "
"0","    mutate(year_submission=files_to_extract$year_submission[i]) %>% "
"0","    select(iso,country,dir,year_submission,sector_code,sector_description=sector,sector_level,gas,units,year,value) %>%"
"0","    mutate(value=as.numeric(value)) %>% "
"0","    mutate(year=as.numeric(year))"
"0","  "
"0","  "
"0","  ## bind to dataset"
"0","  data_crts <- bind_rows(data_crts,table)"
"0","  data_crts_memos <- bind_rows(data_crts_memos,memos)"
"0","  "
"0","}"
"0",""
