"0",""
"0","data <- data_crts_activity"
"0",""
"0","## remove trailing spaces in sector descriptions, text within round brackets"
"0","data$sector <- gsub(""\\(.*?\\)"", """", data$sector)"
"0","data$sector <- gsub(""\\s+$"", """", data$sector)"
"0","data$fuel <- gsub(""\\(.*?\\)"", """", data$fuel)"
"0","data$fuel <- gsub(""\\s+$"", """", data$fuel)"
"0",""
"0",""
"0","## identify leaf nodes"
"0","sectors <- data %>% select(sector_code,sector_level,sector,fuel) %>% distinct()"
"0","sectors <- sectors %>%"
"0","  mutate(is_leaf = !sapply(sector_code, function(code) {"
"0","    any(str_detect(setdiff(sector_code, code), paste0(""^"", str_replace_all(code, ""\\."", ""\\\\.""))))"
"0","  }))"
"0",""
"0",""
"0","## ""Total"" fuel estimates are not leaf nodes, unless they have no child fuels"
"0","sectors <- sectors %>% "
"0","  group_by(sector_code,sector_level,sector) %>% "
"0","  mutate(n=n()) %>% "
"0","  mutate(is_leaf=ifelse(fuel==""Total"" & n!=1,FALSE,is_leaf)) %>% "
"0","  select(-n) %>% "
"0","  ungroup()"
"0",""
"0",""
"0","## propagate sector_lv1"
"0","sectors <- sectors %>% "
"0","  mutate(sector_lv1=""Energy"")"
"0",""
"0",""
"0","## propagate sector_lv2"
"0","sectors <- sectors %>% "
"0","  mutate(match = substr(sector_code,1,3)) %>% "
"0","  left_join(.,sectors %>% "
"0","              filter(sector_level==2) %>%"
"0","              mutate(match=substr(sector_code,1,3)) %>% "
"0","              select(match,sector_lv2=sector) %>% "
"0","              distinct(),"
"0","            by = join_by(match)) %>% "
"0","  select(-match)"
"0",""
"0",""
"0","## propagate sector_lv3"
"0","sectors <- sectors %>% "
"0","  mutate(match = substr(sector_code,1,5)) %>% "
"0","  left_join(.,sectors %>% "
"0","              filter(sector_level==3) %>%"
"0","              mutate(match=substr(sector_code,1,5)) %>% "
"0","              select(match,sector_lv3=sector) %>% "
"0","              distinct(),"
"0","            by = join_by(match)) %>% "
"0","  select(-match)"
"0",""
"0",""
"0","## propagate sector_lv4"
"0","sectors <- sectors %>% "
"0","  mutate(match = substr(sector_code,1,8)) %>% "
"0","  left_join(.,sectors %>% "
"0","              filter(sector_level==4) %>%"
"0","              mutate(match=substr(sector_code,1,8)) %>% "
"0","              select(match,sector_lv4=sector) %>% "
"0","              distinct(),"
"0","            by = join_by(match)) %>% "
"0","  select(-match)"
"0",""
"0",""
"0",""
"0",""
"0","## clean up sectors (no double counting, all codes separate)"
"0","sectors <- sectors %>% "
"0","  filter(is_leaf==TRUE) %>%"
"0","  select(-is_leaf)"
"0",""
"0",""
"0","## rejoin"
"0","data <- left_join(data,sectors,by=join_by(sector_code,sector_level,sector,fuel))"
"0","data_crts_totals <- data %>% filter(is.na(sector_lv1))"
"0",""
"0",""
"0","## tidy up sector hierarchy"
"0","data <- data %>% filter(!is.na(sector_lv1))"
"0",""
"0","data_crts_activity <- data"
"0","save(data_crts_activity,file=""data/data_crts_activity.RData"")"
"0",""
"0",""
