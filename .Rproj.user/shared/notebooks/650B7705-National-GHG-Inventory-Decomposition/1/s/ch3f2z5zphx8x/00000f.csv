"0",""
"0","i=1991"
"0","data_decomp_all <- data.frame()"
"0",""
"0","for (i in 1993:2022) {"
"0","  "
"0","  # select time steps"
"0","  data <- data_decomp %>%"
"0","    filter(year %in% c(i-3,i))"
"0","  "
"0","  # calculate logarithmic mean of the emissions change per sector"
"0","  data <- data %>%"
"0","    group_by(iso,sector_lv4) %>% "
"0","    mutate(w=(last(e_ghg)-first(e_ghg))/(log(last(e_ghg))-log(first(e_ghg)))) %>% "
"0","    mutate(w=ifelse(last(e_ghg)==first(e_ghg),last(e_ghg),w))"
"0","  "
"0","  # calculate activity effect"
"0","  data <- data %>%"
"0","    mutate(aw=log(last(activity_total)/first(activity_total))) %>% "
"0","    mutate(A=w*aw) "
"0","  "
"0","  # calculate structure and intensity effects"
"0","  data <- data %>% "
"0","    group_by(iso,sector_lv4) %>% "
"0","    mutate(S=w*(log(last(activity_share)/first(activity_share)))) %>% "
"0","    mutate(I=w*(log(last(ef_ghg)/first(ef_ghg)))) %>% "
"0","    mutate(E=last(e_ghg)-first(e_ghg))"
"0","  "
"0","  ## check sums"
"0","  data <- data %>%"
"0","    ungroup() %>% "
"0","    mutate(test=A+S+I)"
"0","  "
"0","  ## join"
"0","  data_decomp_all <- rbind(data_decomp_all,data %>% filter(year==i))"
"0","  "
"0","}"
"0",""
"0",""
"0","data_decomp_all <- data_decomp_all %>% arrange(across(2))"
"0",""
"0",""
