table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table <- table %>%
mutate(area=gsub(".","",area))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub(".","",table$area)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub(".","",table$area)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\.","",table$area)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect("Initial area"),"Total managed land",area))
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\("))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(`var` = str_remove_all(`var`, "\\(.*?\\)"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- table %>%
mutate(year=files_to_extract$year_file[i])
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area,everything())
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(tidyverse)
library(openxlsx)
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
mutate(forest_land_extracted=NA)
files_to_extract <- files_crts %>%
arrange(iso,year_file) %>%
filter(is.na(forest_land_extracted))
## prepare data frames
data_land_area <- data.frame()
i=1
for (i in 1:length(files_to_extract$file)) {
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area,everything())
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
}
View(table)
files_to_extract <- files_crts %>%
arrange(iso,year_file) %>%
filter(is.na(forest_land_extracted))
data_land_area <- data.frame()
i=1
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area,everything())
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
View(data_land_area)
i=2
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- table %>%
gather(area,value,-var) %>%
spread(var,value)
table$area=gsub("\\."," ",table$area)
table <- table %>%
mutate(area=ifelse(str_detect(area,"Initial area"),"Total managed land",area))
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area,everything())
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(var=`TO:`,everything()) %>%
filter(str_detect(var, "Final area") | str_detect(var, "Net change")) %>%
filter(!str_detect(var, "^\\(")) %>%
mutate(var = str_remove_all(var, "\\(.*?\\)"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
select(area_from=`TO:`)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`)
table <- table %>%
rename(area_from=`TO:`) %>%
gather(area_to,value,-area_from)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
gather(area_to,value,-area_from)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\("))# %>%
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:")) %>%
mutate(area_from = str_remove_all(area_from, "\\(.*?\\)"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:")) %>%
mutate(area_from = str_remove_all(area_from, "\\(\\d+\\)"))
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:")) %>%
mutate(area_from = str_remove_all(area_from, "\\(\\d+\\)")) %>%
gather(area_to,value,-area_from)
table$area_to=gsub("\\."," ",table$area_to)
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area_from,area_to,value)
data_land_area <- data.frame()
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
View(data_land_area)
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(tidyverse)
library(openxlsx)
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
mutate(forest_land_extracted=NA)
files_to_extract <- files_crts %>%
arrange(iso,year_file) %>%
filter(is.na(forest_land_extracted))
## prepare data frames
data_land_area <- data.frame()
i=2
for (i in 1:length(files_to_extract$file)) {
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:")) %>%
mutate(area_from = str_remove_all(area_from, "\\(\\d+\\)")) %>%
gather(area_to,value,-area_from)
table$area_to=gsub("\\."," ",table$area_to)
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area_from,area_to,value)
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
}
View(data_land_area)
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(tidyverse)
library(openxlsx)
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
mutate(forest_land_extracted=NA)
files_to_extract <- files_crts %>%
arrange(iso,year_file) %>%
filter(is.na(forest_land_extracted))
## prepare data frames
data_land_area <- data.frame()
i=2
for (i in 1:length(files_to_extract$file)) {
table <- read.xlsx(xlsxFile = paste0("sources/done/",files_to_extract$dir[i],"/",files_to_extract$files[i]),
sheet = paste0("Table4.1"),
startRow = 8)
table <- table %>%
rename(area_from=`TO:`) %>%
filter(!str_detect(area_from, "^\\(")) %>%
filter(!str_detect(area_from, "FROM:")) %>%
filter(!str_detect(area_from, "Note:")) %>%
mutate(area_from = str_remove_all(area_from, "\\(\\d+\\)")) %>%
gather(area_to,value,-area_from)
table$area_to=gsub("\\."," ",table$area_to)
table <- table %>%
mutate(year=files_to_extract$year_file[i]) %>%
mutate(year_submission=files_to_extract$year_submission[i]) %>%
mutate(iso=files_to_extract$iso[i])
table <- table %>%
select(iso,year_submission,year,area_from,area_to,value)
## bind to dataset
data_land_area <- bind_rows(data_land_area,table)
}
View(data_land_area)
save(data_land_area,file="data/data_land_area_v1.2.RData")
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(openxlsx)
library(rvest)
library(httr)
library(countrycode)
library(tidyverse)
library(tools)
# Function to fetch and parse the webpage
fetch_webpage <- function(url) {
tryCatch({
page <- GET(url)
if (status_code(page) == 200) {
content <- read_html(page)
return(content)
} else {
stop("Failed to fetch the webpage. HTTP status code: ", status_code(page))
}
}, error = function(e) {
message("Error: ", e$message)
return(NULL)
})
}
# Function to extract links with title "CRT"
extract_crt_links <- function(webpage) {
tryCatch({
# Select anchor (<a>) elements where title contains "CRT"
elements <- webpage %>%
html_elements("a[title*='CRT']")  # Matches any <a> tag with 'CRT' in the title
# Extract href (link) and title
links <- elements %>% html_attr("href")
titles <- elements %>% html_attr("title")
if (length(links) == 0) {
message("No CRT links found on the page.")
return(NULL)
} else {
# Prepend the base URL to form complete links
base_url <- "https://unfccc.int"
full_links <- sapply(links, function(link) {
if (startsWith(link, "/")) {
paste0(base_url, link)
} else {
link
}
})
# Extract country names (assume the first word(s) before the first period in the title)
country_names <- sapply(titles, function(title) {
strsplit(title, "\\.", fixed = FALSE)[[1]][1]
})
# Combine country names and links into a data frame
result <- data.frame(country = country_names, link = full_links, stringsAsFactors = FALSE)
return(result)
}
}, error = function(e) {
message("Error during link extraction: ", e$message)
return(NULL)
})
}
## Check BTR webpage
btr_webpage <- fetch_webpage("https://unfccc.int/first-biennial-transparency-reports")
btr_links <- extract_crt_links(btr_webpage) %>%
mutate(iso=countrycode(country,'country.name','iso3c'))
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
select(iso,year_submission) %>%
distinct() %>%
filter(year_submission==2024) %>%
mutate(compiled=1)
btr_links <- btr_links %>%
left_join(.,files_crts,by=join_by(iso)) %>%
filter(is.na(compiled))
## Check Annex I national inventory webpage
ai_webpage <- fetch_webpage("https://unfccc.int/ghg-inventories-annex-i-parties/2025")
ai_links <- extract_crt_links(ai_webpage) %>%
mutate(iso=countrycode(country,'country.name','iso3c'))
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
select(iso,year_submission) %>%
distinct() %>%
filter(year_submission==2025) %>%
mutate(compiled=1)
ai_links <- ai_links %>%
left_join(.,files_crts,by=join_by(iso)) %>%
filter(is.na(compiled))
## Now go and download the files in those links, put them in the "sources/new/" folder
rm(files_crts)
btr_webpage <- fetch_webpage("https://unfccc.int/first-biennial-transparency-reports")
btr_links <- extract_crt_links(btr_webpage) %>%
mutate(iso=countrycode(country,'country.name','iso3c'))
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
select(iso,year_submission) %>%
distinct() %>%
filter(year_submission==2024) %>%
mutate(compiled=1)
btr_links <- btr_links %>%
left_join(.,files_crts,by=join_by(iso)) %>%
filter(is.na(compiled))
View(btr_links)
ai_webpage <- fetch_webpage("https://unfccc.int/ghg-inventories-annex-i-parties/2025")
ai_links <- extract_crt_links(ai_webpage) %>%
mutate(iso=countrycode(country,'country.name','iso3c'))
load("sources/data_crt_files.RData")
files_crts <- files_crts %>%
select(iso,year_submission) %>%
distinct() %>%
filter(year_submission==2025) %>%
mutate(compiled=1)
ai_links <- ai_links %>%
left_join(.,files_crts,by=join_by(iso)) %>%
filter(is.na(compiled))
View(ai_links)
